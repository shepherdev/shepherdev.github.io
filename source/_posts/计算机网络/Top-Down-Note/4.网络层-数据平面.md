---
![ip-v4-format](/home/shepherdev/blog_image/article/2020/ip-v4-format.png)![ip-v4-format](/home/shepherdev/blog_image/article/2020/ip-v4-format.png)title: 4.网络层-数据平面
date: 2020-06-01 21:00
author: shepherd
toc: true
mathJax: true
categories: [计算机网络,Top-Down-Note]
tags: []
---

 网络层分两部分讲解，数据平面和控制平面(区分这两个概念很重要)，该章主要讲解了数据报输入输出链路的选择、IP转发、通用转发、IPv4和IPv6.

> 理清楚术语有利于学习本章: 数据包和分组是同一概念, 都是packet翻译过来的. 数据报和数据包有点类似, 比如UDP数据报, IP数据报, TCP数据包, UDP数据包, IP数据包..

<!-- more -->

## 4.1-Overview

路由器的数据平面将数据报从输入链路**转发**到输出链路，网络控制平面主要控制着数据报进行端到端传输。

### 4.1.1-转发和路由-数据和控制平面

将数据发送至目标主机，有两个重要的网络层功能。

- **转发**：数据包在单一路由器里从输入到选择合适的输出链路（几纳秒），对应数据平面
- **路由**：网络层必须在所有路由器中确定数据包采用的路由或路径（几秒），相关算法称为路由算法，对应控制平面

路由器的关键是**转发表**，路由器会检查每个数据包首部字段，查询转发表以确定输出链路。

*控制平面的传统方法*

每个路由器都有一个可以和其他路由器通信的路由组件，路由器之间通过通信计算转发表的值

*控制平面的SDN方法*

 software-defined networking (SDN)将控制平面提升到了远程控制，通过远程控制器来分配转发表的值。

### 4.1.2-网络服务模型

网络服务模型定义了发送方与接收方之间数据包的传递特性.

网络层能提供的**部分服务:**

- **保证交付数据**: 确保源数据包可以到达目的主机. 此外还可以指定时延范围进行传递
- **有序的数据包**: 保证数据包按照发送顺序到达目的主机. 
- ***保证最小带宽**: 在指定的链路速率下, 只要发送速率低于链路速率, 那么所有数据包都会到达目的主机.  
- **安全性**: 在源主机进行加密, 目的主机进行解密即可保证安全性.

但是Internet网络层提供的是**尽力而为服务**, 不保证**到达-延迟-带宽,** 虽然有其他模型满足上述服务, 但事实证明了尽力而为服务和现下非常契合. 

> 注意: 有两种类型交换机, 针对网络层的叫数据包交换机, 转发策略根据数据包头的信息决定, 通俗来说把数据包交换机叫路由器; 针对链路层的交换机是链路层设备. 

## 4.2-路由器组成和作用

路由器架构如图

![router-architecture](/home/shepherdev/blog_image/article/2020/router-architecture.png)

- **输入端口**

  这个端口不是TCP套接字的端口, 而是代表物理端口(或者说接口更合适), 图中三个方框分别代表物理层, 链路层, 网络层. 
  

  功能: 1. 物理链路与物理层的交互. 2. 链路层的交互. 3. 网络层, 查询转发表将数据包通过**交换结构**转发到输出接口. 


- **交换结构**

  将输入端口连接到输出端口, 它完全包含在路由器中, 是一个网络路由器中的网络. 

- **输出端口*

  存储从交换结构得到的数据包, 通过执行链路层和物理层的功能后在传输链路上进行传输(也可以取消). 如果链路是双向传输, 则输入和输出端口在印刷电路上有特殊的结构

- **路由处理器**

  执行的是控制平面的功能. 

  在传统的路由器中, 执行**路由器协议**, 维护路由表和链路状态信息, 并计算转发表.

  在SDN的路由器中, 它负责和远程控制器通信, 为路由器计算转发表

> 各个部分都使用了物理硬件来实现, 因为数据到达通常是ns级的, 对于软件来说太快了


### 4.2.1-输入端口细节

输入端口通过`转发表`来找输出端口, 而转发表则由`路由处理器`计算或者从`SDN`接受. 转发表通过一条总线复制到每个端口, 避免了集中处理.

在32位的IP地址中, 转发表如果为每一个可能的地址都分配了一个条目, 而地址可能有40多亿, 这不大现实. 一般来说, 会在某段地址范围之间选择一个链接接口. 也会采用前缀的形式进行选择, 如下

| IP前缀            | 转发链路接口 |
| ----------------- | ------------ |
| 11001000 0010     | 0            |
| 11001000 00100011 | 1            |
| 11001000 011      | 2            |
| 其他              | 3            |

> 如果匹配多项, 则会挑前缀最长的那项
>
> cisco catalyst 6500, 7600系列有一百万个TCAM转发表条目

为了更快的(ns)在转发表中查找, 一般选择使用`SRAM`和`TCAM`存储器.

确定输出端口后, 就将数据包发给交换结构(牵扯到排队拥塞调度),  **查找**是输入端口中最重要的一个功能, 除此之外还有

- 进行物理与链路层处理
- 检查数据包的版本号, 校验, 生存时间
- 更新网络管理的计数器

### 4.2.2-交换结构(switching fabric)细节

是路由器的核心, 有多种数据包交换(指从输入端口到输出端口)方式

1. 通过内存转发.

   输入输出相当于操作系统的IO, CPU(路由处理器)从数据包首部取出目的地址, 在转发表中找到输出端口后, 就将数据包复制到输出端口的缓冲区.(即使有不同的输出端口, 但因为是共享系统总线, 一次只能进行一次读写, *区别线路卡*)

   许多路由器都使用内存交换技术。然而，目的地址的查找和将分组存储(交换)进适当的存储位置是由输入线路卡上的处理器来执行的。

2.  通过总线转发.

   输入端口通过共享总线将数据包直接转送到输出端口, 不需要路由处理器.

   虽然CPU没有涉及总线传送, 但因为总线共享, 还是只能一次传送一个数据包. 当数据包到达输入端口, 如果发现总线在忙, 他就会被阻塞(数据包进入内存需要通过总线).

3. 通过互连网转发.

   使用互连网络, 可以克服共享总线带宽的限制, 当不同输入端口转发到不同输出端口时, 能够并行转发

### 4.2.3-排队

将输入链路速率和输出速率相等设为R, 交换结构处理速率设为L

- R<<L

  不存在输入排队, 存在输出排队

- R>L

  存在输入排队, 并且存在HOL(Head of the line)阻塞, 即排队第一个数据包被阻塞, 后面的数据包也会被影响

### 4.2.4-数据包调度

如何处理排队, 这就是调度

#### 1.FIFO(FCFS)

先进先出(先到先服务)指的是**按照到达顺序**将队列数据包进行链路传输, 先到的先被处理

#### 2.优先级

到达的数据包会进行分类, 高优先级队列的会比低优先级队列的先被传输, 优先级相同的数据包采用FIFO处理 

#### 3.轮循(RR)和加权公平排队(WFQ)

轮循就是循环不同的队列来发送数据包. 

WFQ与RR有点像, 但它为每一个队列进行**加权**, 避免优先级低的得不到服务, 还有就是采用轮循, 当队列为空时, 立刻切换到下一个队列

## 4.3-IPv4, IPv6

对于网络, IP可以说是最为重要的一部分了(寻址, 转发), 下图就是IPv4报头的组成部分

![](/home/shepherdev/blog_image/article/2020/ip-v4-format.png)

- `version`: IP协议的版本号, 路由器根据不同的版本来解析IP数据报头
- `Headerlength`: 代表IP头的长度, 用来确定有效载荷, 典型的IP头是20字节(不包含该选项)
- `Type of service`: 服务类型用来区分不同类型的数据报, 如IP电话和FTP的数据报
- 

